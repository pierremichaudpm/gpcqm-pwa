<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test CMS - Mode Autonome</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .status {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .success { color: #27ae60; }
        .error { color: #e74c3c; }
        .warning { color: #f39c12; }
        .info { color: #3498db; }
        button {
            background: #6BA053;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #5a8a45;
        }
        .data-display {
            background: white;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
            max-height: 400px;
            overflow-y: auto;
        }
        pre {
            margin: 0;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>üîß Test du CMS GPCM</h1>
    
    <div class="status">
        <h2>√âtat du syst√®me</h2>
        <p id="serverStatus">V√©rification du serveur...</p>
        <p id="localStorageStatus">V√©rification du localStorage...</p>
        <p id="dataStatus">V√©rification des donn√©es...</p>
    </div>
    
    <div class="status">
        <h2>Actions de test</h2>
        <button onclick="testServerConnection()">Tester la connexion serveur</button>
        <button onclick="loadLocalData()">Charger donn√©es locales</button>
        <button onclick="clearLocalData()">Effacer donn√©es locales</button>
        <button onclick="loadDefaultData()">Charger donn√©es par d√©faut</button>
        <button onclick="window.open('/cms', '_blank')">Ouvrir le CMS</button>
    </div>
    
    <div class="status">
        <h2>Donn√©es actuelles</h2>
        <div class="data-display">
            <pre id="dataDisplay">Aucune donn√©e charg√©e</pre>
        </div>
    </div>
    
    <script>
        // Test initial
        window.addEventListener('DOMContentLoaded', () => {
            checkSystem();
        });
        
        async function checkSystem() {
            // V√©rifier le serveur
            await testServerConnection();
            
            // V√©rifier localStorage
            checkLocalStorage();
            
            // V√©rifier les donn√©es
            checkData();
        }
        
        async function testServerConnection() {
            const status = document.getElementById('serverStatus');
            try {
                const response = await fetch('/api/teams', { 
                    method: 'GET',
                    signal: AbortSignal.timeout(2000)
                });
                
                if (response.ok) {
                    const teams = await response.json();
                    status.innerHTML = '<span class="success">‚úÖ Serveur connect√© - ' + teams.length + ' √©quipes trouv√©es</span>';
                    displayData(teams);
                } else {
                    status.innerHTML = '<span class="warning">‚ö†Ô∏è Serveur accessible mais erreur: ' + response.status + '</span>';
                }
            } catch (error) {
                status.innerHTML = '<span class="error">‚ùå Serveur non accessible - Mode hors ligne activ√©</span>';
                console.log('Erreur serveur:', error);
            }
        }
        
        function checkLocalStorage() {
            const status = document.getElementById('localStorageStatus');
            try {
                const data = localStorage.getItem('gpcm_teams_data');
                if (data) {
                    const teams = JSON.parse(data);
                    status.innerHTML = '<span class="success">‚úÖ Donn√©es locales trouv√©es - ' + teams.length + ' √©quipes</span>';
                } else {
                    status.innerHTML = '<span class="info">‚ÑπÔ∏è Aucune donn√©e locale</span>';
                }
            } catch (error) {
                status.innerHTML = '<span class="error">‚ùå Erreur localStorage: ' + error.message + '</span>';
            }
        }
        
        function checkData() {
            const status = document.getElementById('dataStatus');
            const localData = localStorage.getItem('gpcm_teams_data');
            
            if (localData) {
                try {
                    const teams = JSON.parse(localData);
                    const totalRiders = teams.reduce((sum, team) => sum + (team.riders ? team.riders.length : 0), 0);
                    status.innerHTML = '<span class="success">‚úÖ ' + teams.length + ' √©quipes, ' + totalRiders + ' coureurs au total</span>';
                } catch (error) {
                    status.innerHTML = '<span class="error">‚ùå Donn√©es corrompues</span>';
                }
            } else {
                status.innerHTML = '<span class="warning">‚ö†Ô∏è Aucune donn√©e disponible</span>';
            }
        }
        
        function loadLocalData() {
            const data = localStorage.getItem('gpcm_teams_data');
            if (data) {
                const teams = JSON.parse(data);
                displayData(teams);
                alert('Donn√©es locales charg√©es: ' + teams.length + ' √©quipes');
            } else {
                alert('Aucune donn√©e locale trouv√©e');
            }
        }
        
        function clearLocalData() {
            if (confirm('√ätes-vous s√ªr de vouloir effacer toutes les donn√©es locales?')) {
                localStorage.removeItem('gpcm_teams_data');
                checkSystem();
                alert('Donn√©es locales effac√©es');
            }
        }
        
        function loadDefaultData() {
            const defaultTeams = [
                {
                    id: 1,
                    name: "UAE Team Emirates",
                    displayName: "UAE TEAM EMIRATES XRG",
                    country: "üá¶üá™",
                    jerseyPath: "",
                    riders: [
                        { number: 11, name: "Tadej POGACAR", country: "üá∏üáÆ" },
                        { number: 12, name: "Brandon MCNULTY", country: "üá∫üá∏" }
                    ]
                },
                {
                    id: 2,
                    name: "√âquipe Canada",
                    displayName: "√âQUIPE NATIONALE CANADA",
                    country: "üá®üá¶",
                    jerseyPath: "",
                    riders: [
                        { number: 221, name: "Philippe JACOB", country: "üá®üá¶" },
                        { number: 222, name: "J√©r√¥me GAUTHIER", country: "üá®üá¶" }
                    ]
                }
            ];
            
            localStorage.setItem('gpcm_teams_data', JSON.stringify(defaultTeams));
            displayData(defaultTeams);
            checkSystem();
            alert('Donn√©es par d√©faut charg√©es');
        }
        
        function displayData(teams) {
            const display = document.getElementById('dataDisplay');
            if (teams && teams.length > 0) {
                const summary = teams.map(team => ({
                    nom: team.displayName || team.name,
                    pays: team.country,
                    coureurs: team.riders ? team.riders.length : 0
                }));
                display.textContent = JSON.stringify(summary, null, 2);
            } else {
                display.textContent = 'Aucune √©quipe';
            }
        }
    </script>
</body>
</html>
