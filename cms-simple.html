<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CMS GPCM - Version Simple</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; text-align: center; }
        .container { max-width: 1400px; margin: 20px auto; padding: 0 20px; }
        .stats { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .main-grid { display: grid; grid-template-columns: 300px 1fr; gap: 20px; }
        .teams-panel { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); height: fit-content; }
        .editor-panel { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .team-card { padding: 15px; margin: 10px 0; background: #f8f9fa; border-radius: 8px; cursor: pointer; transition: all 0.3s; }
        .team-card:hover { background: #e9ecef; transform: translateX(5px); }
        .team-card.active { background: #667eea; color: white; }
        .btn { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; }
        .btn-primary { background: #667eea; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn:hover { opacity: 0.9; }
        .rider-row { padding: 10px; margin: 5px 0; background: #f8f9fa; border-radius: 5px; }
        .rider-inputs { display: grid; grid-template-columns: 60px 1fr 100px 50px; gap: 10px; align-items: center; }
        .rider-inputs input { padding: 5px; border: 1px solid #ddd; border-radius: 3px; }
        .input-group { margin: 10px 0; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .input-group input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 500px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .close-btn { font-size: 30px; cursor: pointer; color: #999; }
        .close-btn:hover { color: #333; }
        #message { position: fixed; top: 20px; right: 20px; padding: 15px 25px; border-radius: 5px; display: none; z-index: 2000; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>
    <div class="header">
        <h1>🚴‍♂️ CMS GPCM - Gestion des Équipes</h1>
        <p>Interface simplifiée de gestion</p>
    </div>

    <div class="container">
        <div style="margin-bottom: 20px; text-align: right;">
            <button id="saveBtn" class="btn btn-success">💾 Sauvegarder tout</button>
            <button id="refreshBtn" class="btn btn-primary">🔄 Rafraîchir</button>
        </div>

        <div class="main-grid">
            <div class="teams-panel">
                <h3>📁 Équipes</h3>
                <button id="addTeamBtn" class="btn btn-primary" style="width: 100%; margin: 10px 0;">➕ Nouvelle équipe</button>
                <div id="teamsList"></div>
            </div>

            <div class="editor-panel">
                <div id="welcome">
                    <h2>👋 Bienvenue</h2>
                    <p>Sélectionnez une équipe pour commencer</p>
                </div>
                <div id="editor" style="display: none;">
                    <h2 id="teamTitle"></h2>
                    
                    <div class="input-group">
                        <label>Nom de l'équipe:</label>
                        <input type="text" id="teamName">
                    </div>
                    
                    <div class="input-group">
                        <label>Nom affiché:</label>
                        <input type="text" id="teamDisplayName" placeholder="Nom pour l'affichage">
                    </div>
                    
                    <div class="input-group">
                        <label>Code (3 lettres):</label>
                        <input type="text" id="teamCode" maxlength="3">
                    </div>

                    <h3>Coureurs</h3>
                    <button class="btn btn-primary" onclick="openAddRider()">➕ Ajouter un coureur</button>
                    <div style="margin-top: 15px;">
                        <div class="rider-inputs" style="font-weight: bold; margin-bottom: 10px;">
                            <span>Numéro</span>
                            <span>Nom</span>
                            <span>Pays</span>
                            <span></span>
                        </div>
                        <div id="ridersList"></div>
                    </div>
                    
                    <hr style="margin: 20px 0;">
                    <button class="btn btn-danger" onclick="deleteTeam()">🗑️ Supprimer cette équipe</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Équipe -->
    <div id="teamModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Nouvelle équipe</h2>
                <span class="close-btn" onclick="closeModal('teamModal')">&times;</span>
            </div>
            <div class="input-group">
                <label>Nom:</label>
                <input type="text" id="newTeamName">
            </div>
            <div class="input-group">
                <label>Nom affiché:</label>
                <input type="text" id="newTeamDisplayName" placeholder="Nom pour l'affichage">
            </div>
            <div class="input-group">
                <label>Code:</label>
                <input type="text" id="newTeamCode" maxlength="3">
            </div>
            <button class="btn btn-primary" onclick="addTeam()">Créer</button>
            <button class="btn" onclick="closeModal('teamModal')">Annuler</button>
        </div>
    </div>

    <!-- Modal Coureur -->
    <div id="riderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Nouveau coureur</h2>
                <span class="close-btn" onclick="closeModal('riderModal')">&times;</span>
            </div>
            <div class="input-group">
                <label>Numéro:</label>
                <input type="number" id="newRiderNumber">
            </div>
            <div class="input-group">
                <label>Nom:</label>
                <input type="text" id="newRiderName">
            </div>
            <div class="input-group">
                <label>Pays:</label>
                <input type="text" id="newRiderCountry">
            </div>
            <button class="btn btn-primary" onclick="addRider()">Ajouter</button>
            <button class="btn" onclick="closeModal('riderModal')">Annuler</button>
        </div>
    </div>

    <div id="message"></div>

    <script>
        let teams = [];
        let currentTeam = null;
        
        // Liste des drapeaux disponibles
        const flags = {
            '🇦🇺': 'AUS - Australie',
            '🇦🇹': 'AUT - Autriche',
            '🇧🇪': 'BEL - Belgique',
            '🇧🇷': 'BRA - Brésil',
            '🇨🇦': 'CAN - Canada',
            '🇨🇭': 'CHE - Suisse',
            '🇨🇴': 'COL - Colombie',
            '🇨🇿': 'CZE - Tchéquie',
            '🇩🇰': 'DEN - Danemark',
            '🇩🇪': 'GER - Allemagne',
            '🇪🇨': 'ECU - Équateur',
            '🇪🇸': 'ESP - Espagne',
            '🇪🇪': 'EST - Estonie',
            '🇫🇷': 'FRA - France',
            '🇬🇧': 'GBR - Royaume-Uni',
            '🇭🇺': 'HUN - Hongrie',
            '🇮🇪': 'IRL - Irlande',
            '🇮🇹': 'ITA - Italie',
            '🇯🇵': 'JPN - Japon',
            '🇱🇺': 'LUX - Luxembourg',
            '🇲🇽': 'MEX - Mexique',
            '🇳🇱': 'NED - Pays-Bas',
            '🇳🇴': 'NOR - Norvège',
            '🇳🇿': 'NZL - Nouvelle-Zélande',
            '🇵🇱': 'POL - Pologne',
            '🇵🇹': 'POR - Portugal',
            '🇷🇺': 'RUS - Russie',
            '🇸🇮': 'SLO - Slovénie',
            '🇸🇰': 'SVK - Slovaquie',
            '🇿🇦': 'RSA - Afrique du Sud',
            '🇸🇪': 'SWE - Suède',
            '🇺🇸': 'USA - États-Unis',
            '🇦🇪': 'UAE - Émirats',
            '🇰🇿': 'KAZ - Kazakhstan',
            '🇦🇷': 'ARG - Argentine',
            '🇨🇳': 'CHN - Chine',
            '🇰🇷': 'KOR - Corée du Sud',
            '🇮🇳': 'IND - Inde',
            '🇺🇦': 'UKR - Ukraine',
            '🇱🇻': 'LAT - Lettonie',
            '🇱🇹': 'LTU - Lituanie'
        };

        // Charger les données
        async function init() {
            try {
                const response = await fetch('/api/teams');
                teams = await response.json();
                console.log('Loaded', teams.length, 'teams');
                render();
            } catch (error) {
                console.error('Error:', error);
                showMessage('Erreur de chargement', 'error');
            }
        }

        // Afficher tout
        function render() {
            // Liste des équipes
            const list = document.getElementById('teamsList');
            list.innerHTML = teams.map(team => 
                `<div class="team-card ${currentTeam?.id === team.id ? 'active' : ''}" data-team-id="${team.id}">
                    <strong>${team.displayName || team.name || 'Sans nom'}</strong><br>
                    <small>${team.riders?.length || 0} coureurs</small>
                </div>`
            ).join('');
            
            // Ajouter les event listeners pour chaque carte d'équipe
            document.querySelectorAll('.team-card').forEach(card => {
                card.addEventListener('click', function() {
                    const teamId = parseInt(this.getAttribute('data-team-id'));
                    selectTeam(teamId);
                });
            });

            // Éditeur
            if (currentTeam) {
                document.getElementById('teamTitle').textContent = currentTeam.displayName || currentTeam.name || 'Équipe';
                document.getElementById('teamName').value = currentTeam.name || '';
                document.getElementById('teamDisplayName').value = currentTeam.displayName || '';
                document.getElementById('teamCode').value = currentTeam.code || '';

                const ridersList = document.getElementById('ridersList');
                ridersList.innerHTML = (currentTeam.riders || []).map((rider, i) => {
                    // Créer les options pour le sélecteur de drapeaux
                    const flagOptions = Object.entries(flags).map(([flag, name]) => 
                        `<option value="${flag}" ${rider.country === flag ? 'selected' : ''}>${flag} ${name}</option>`
                    ).join('');
                    
                    return `<div class="rider-row">
                        <div class="rider-inputs">
                            <input type="number" value="${rider.number || ''}" placeholder="#" data-rider="${i}" data-field="number">
                            <input type="text" value="${rider.name || ''}" placeholder="Nom du coureur" data-rider="${i}" data-field="name">
                            <select data-rider="${i}" data-field="country">
                                <option value="">-- Pays --</option>
                                ${flagOptions}
                            </select>
                            <button class="btn btn-danger" data-rider-index="${i}">×</button>
                        </div>
                    </div>`;
                }).join('');
                
                // Ajouter les event listeners pour les inputs et selects
                ridersList.querySelectorAll('input, select').forEach(element => {
                    element.addEventListener('change', function() {
                        const riderIndex = parseInt(this.getAttribute('data-rider'));
                        const field = this.getAttribute('data-field');
                        if (currentTeam.riders && currentTeam.riders[riderIndex]) {
                            currentTeam.riders[riderIndex][field] = this.value;
                        }
                    });
                });
                
                // Ajouter les event listeners pour les boutons de suppression
                ridersList.querySelectorAll('.btn-danger').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const index = parseInt(this.getAttribute('data-rider-index'));
                        removeRider(index);
                    });
                });
            }
        }

        // Sélectionner une équipe
        function selectTeam(id) {
            currentTeam = teams.find(t => t.id === id);
            document.getElementById('welcome').style.display = 'none';
            document.getElementById('editor').style.display = 'block';
            render();
        }

        // Mettre à jour l'équipe courante
        function updateCurrentTeam() {
            if (!currentTeam) return;
            currentTeam.name = document.getElementById('teamName').value;
            currentTeam.displayName = document.getElementById('teamDisplayName').value;
            currentTeam.code = document.getElementById('teamCode').value;
            render();
        }

        // Ajouter une équipe
        function openAddTeam() {
            document.getElementById('newTeamName').value = '';
            document.getElementById('newTeamDisplayName').value = '';
            document.getElementById('newTeamCode').value = '';
            document.getElementById('teamModal').classList.add('active');
        }

        function addTeam() {
            const name = document.getElementById('newTeamName').value;
            if (!name) {
                alert('Le nom est requis');
                return;
            }

            const newTeam = {
                id: Math.max(...teams.map(t => t.id || 0), 0) + 1,
                name: name,
                displayName: document.getElementById('newTeamDisplayName').value || name,
                code: document.getElementById('newTeamCode').value,
                riders: []
            };

            teams.push(newTeam);
            closeModal('teamModal');
            selectTeam(newTeam.id);
            showMessage('Équipe ajoutée', 'success');
        }

        // Supprimer l'équipe courante
        function deleteTeam() {
            if (!currentTeam) return;
            if (!confirm(`Supprimer l'équipe ${currentTeam.name} ?`)) return;

            teams = teams.filter(t => t.id !== currentTeam.id);
            currentTeam = null;
            document.getElementById('welcome').style.display = 'block';
            document.getElementById('editor').style.display = 'none';
            render();
            showMessage('Équipe supprimée', 'success');
        }

        // Ajouter un coureur
        function openAddRider() {
            document.getElementById('newRiderNumber').value = '';
            document.getElementById('newRiderName').value = '';
            document.getElementById('newRiderCountry').value = '';
            document.getElementById('riderModal').classList.add('active');
        }

        function addRider() {
            if (!currentTeam) return;

            const name = document.getElementById('newRiderName').value;
            if (!name) {
                alert('Le nom est requis');
                return;
            }

            if (!currentTeam.riders) currentTeam.riders = [];
            currentTeam.riders.push({
                number: document.getElementById('newRiderNumber').value,
                name: name,
                country: document.getElementById('newRiderCountry').value
            });

            closeModal('riderModal');
            render();
            showMessage('Coureur ajouté', 'success');
        }

        // Supprimer un coureur
        function removeRider(index) {
            if (!currentTeam || !currentTeam.riders) return;
            currentTeam.riders.splice(index, 1);
            render();
        }

        // Sauvegarder
        async function saveAll() {
            console.log('Sauvegarde en cours...', teams.length, 'équipes');
            try {
                const response = await fetch('/api/teams', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(teams)
                });

                console.log('Réponse:', response.status, response.statusText);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Succès:', result);
                    showMessage('✅ Sauvegarde réussie!', 'success');
                } else {
                    const error = await response.text();
                    console.error('Erreur serveur:', error);
                    showMessage('Erreur de sauvegarde: ' + response.status, 'error');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showMessage('Erreur: ' + error.message, 'error');
            }
        }

        // Fermer modal
        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        // Message
        function showMessage(text, type) {
            const msg = document.getElementById('message');
            msg.textContent = text;
            msg.className = type;
            msg.style.display = 'block';
            setTimeout(() => msg.style.display = 'none', 3000);
        }

        // Fermer modals avec Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal('teamModal');
                closeModal('riderModal');
            }
        });

        // Fermer modal en cliquant dehors
        document.getElementById('teamModal').addEventListener('click', (e) => {
            if (e.target.id === 'teamModal') closeModal('teamModal');
        });
        document.getElementById('riderModal').addEventListener('click', (e) => {
            if (e.target.id === 'riderModal') closeModal('riderModal');
        });

        // Event listeners pour les boutons principaux
        document.getElementById('saveBtn').addEventListener('click', saveAll);
        document.getElementById('refreshBtn').addEventListener('click', () => location.reload());
        
        // Event listeners pour les champs de l'équipe
        document.getElementById('teamName').addEventListener('change', updateCurrentTeam);
        document.getElementById('teamDisplayName').addEventListener('change', updateCurrentTeam);
        document.getElementById('teamCode').addEventListener('change', updateCurrentTeam);
        
        // Démarrer
        init();
    </script>
</body>
</html>
